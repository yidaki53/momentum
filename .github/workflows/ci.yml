name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --with dev

      - name: Lint
        run: poetry run ruff check momentum/ tests/

      - name: Test with coverage
        run: poetry run pytest tests/ --cov=momentum --cov-report=term-missing --cov-fail-under=70 -q

  build:
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: momentum-linux
            separator: ":"
          - os: macos-latest
            artifact: momentum-macos
            separator: ":"
          - os: windows-latest
            artifact: momentum-windows
            separator: ";"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --with dev

      - name: Build standalone binary
        shell: bash
        run: |
          poetry run pyinstaller \
            --onefile \
            --name momentum \
            --add-data "ENCOURAGEMENTS.md${{ matrix.separator }}." \
            --add-data "IMAGES.md${{ matrix.separator }}." \
            --hidden-import momentum \
            --hidden-import PIL._tkinter_finder \
            --clean \
            momentum/cli.py

      - name: Verify binary runs
        shell: bash
        run: |
          if [ -f dist/momentum.exe ]; then
            dist/momentum.exe --help
          else
            dist/momentum --help
          fi

      - name: Build .deb package (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev
          sudo gem install fpm

          VERSION=$(pip install poetry > /dev/null 2>&1; poetry version -s)

          # Create staging directory
          mkdir -p deb-staging/usr/local/bin
          mkdir -p deb-staging/usr/local/share/momentum
          mkdir -p deb-staging/usr/share/applications

          cp dist/momentum deb-staging/usr/local/bin/momentum
          chmod 755 deb-staging/usr/local/bin/momentum
          cp ENCOURAGEMENTS.md deb-staging/usr/local/share/momentum/
          cp IMAGES.md deb-staging/usr/local/share/momentum/

          cat > deb-staging/usr/share/applications/momentum.desktop <<EOF
          [Desktop Entry]
          Name=Momentum
          Comment=A gentle tool for executive dysfunction support
          Exec=/usr/local/bin/momentum gui
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          # Strip leading whitespace from heredoc
          sed -i 's/^          //' deb-staging/usr/share/applications/momentum.desktop

          fpm -s dir -t deb \
            -n momentum \
            -v "$VERSION" \
            --description "A gentle CLI and GUI tool to help people with executive dysfunction get back on track" \
            --maintainer "Robin Oberg <robinoberg@live.com>" \
            --url "https://github.com/yidaki53/momentum" \
            --license MIT \
            --depends python3-tk \
            -C deb-staging \
            -p "momentum_${VERSION}_amd64.deb" \
            .

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p artifacts
          if [ -f dist/momentum.exe ]; then
            cp dist/momentum.exe "artifacts/${{ matrix.artifact }}.exe"
          else
            cp dist/momentum "artifacts/${{ matrix.artifact }}"
          fi
          # Include .deb if it was built
          if ls momentum_*.deb 1>/dev/null 2>&1; then
            cp momentum_*.deb artifacts/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: artifacts/

  build-apk:
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev libssl-dev \
            autoconf automake libtool libltdl-dev pkg-config zlib1g-dev \
            unzip zip

      - name: Install buildozer and Cython
        run: |
          pip install buildozer cython==0.29.36

      - name: Create mobile symlinks
        run: |
          cd mobile
          ln -sf ../momentum momentum
          ln -sf ../ENCOURAGEMENTS.md ENCOURAGEMENTS.md
          ln -sf ../SCIENCE.md SCIENCE.md
          ln -sf ../README.md README.md
          ln -sf ../IMAGES.md IMAGES.md

      - name: Build APK
        run: |
          cd mobile
          # Override build_dir for CI (no USB stick)
          sed -i 's|^build_dir.*|build_dir = /tmp/buildozer-build|' buildozer.spec

          # Pre-install Cython into the directory p4a will use as PYTHONPATH
          # for hostpython3.  p4a sets PYTHONNOUSERSITE=1 and overrides
          # PYTHONPATH to *only* this directory, so system-installed Cython
          # is invisible during the numpy build.
          HP_SITE="/tmp/buildozer-build/android/platform/build-arm64-v8a_armeabi-v7a/build/other_builds/hostpython3/desktop/hostpython3/native-build/Lib/site-packages"
          mkdir -p "$HP_SITE"
          pip install --target="$HP_SITE" Cython==0.29.36

          buildozer android debug

      - name: Prepare APK artifact
        run: |
          mkdir -p artifacts
          cp mobile/bin/*.apk artifacts/momentum-android.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: momentum-android
          path: artifacts/momentum-android.apk

  release:
    needs: [build, build-apk]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Get version
        id: version
        run: echo "version=$(poetry version -s)" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-build.${{ github.run_number }}
          name: Momentum v${{ steps.version.outputs.version }} (build ${{ github.run_number }})
          body: |
            Automated build from commit ${{ github.sha }}.

            Download the binary for your platform and run it directly -- no Python required.

            - **Linux**: `momentum-linux` (standalone binary) or `momentum_<version>_amd64.deb` (Debian/Ubuntu package)
            - **macOS**: `momentum-macos`
            - **Windows**: `momentum-windows.exe`
            - **Android**: `momentum-android.apk`
          files: release-assets/*
          draft: false
          prerelease: false
